# 审计沟通利器

专业、高效、有理有据的AI驱动审计沟通工具

## 🎯 项目概述

这是一个基于Next.js 14的AI驱动审计沟通工具，帮助审计人员快速生成专业、有理有据的回复内容，提高沟通效率。支持桌面端和移动端使用。

## ✨ 核心功能

### 💬 智能沟通生成
- **输入对方话语**：支持文字输入和语音识别
- **调整语气强度**：1-10级可调节的语气强烈程度
- **AI智能回复**：基于DeepSeek V3 Base模型的专业审计回复生成
- **历史记录**：保存所有沟通记录，支持回顾和参考

### 🎤 语音功能（已完美修复，支持移动端）
- **语音输入**：点击麦克风图标开始语音识别
- **实时识别**：边说边显示识别结果
- **自动添加**：停顿2秒后自动添加到输入框（桌面端）
- **移动端优化**：移动设备自动切换为单句识别模式
- **语音播放**：支持播放输入内容和AI回复
- **浏览器兼容**：支持Chrome、Edge、Safari等现代浏览器
- **设备自适应**：自动检测设备类型并应用最佳配置

### 📱 移动端特性
- **设备检测**：自动识别移动设备并启用优化模式
- **权限管理**：移动端专用的麦克风权限获取流程
- **单句识别**：移动端使用非连续模式，每次识别一句话
- **超时保护**：10秒超时机制防止无限等待
- **用户提示**：针对移动端的专门使用指导

### 🎨 语音命令控制
支持以下语音命令：
- **"开始沟通"** - 生成AI回复
- **"清空输入"** - 清除输入内容  
- **"增强语气"** - 提高语气强度
- **"减弱语气"** - 降低语气强度

### 🔧 技术特性
- **Next.js 14 App Router** - 最新的React框架
- **TypeScript** - 类型安全的开发体验
- **Tailwind CSS** - 现代化的UI设计
- **Shadcn/ui组件** - 高质量的UI组件库
- **Web Speech API** - 原生浏览器语音识别
- **原生 Fetch API** - 轻量级HTTP客户端，无需额外依赖
- **环境变量安全** - API密钥安全存储，避免泄露风险
- **响应式设计** - 完美适配桌面端和移动端

## 🚀 快速开始

### 环境要求
- Node.js 18+ 
- npm或yarn包管理器
- 现代浏览器（推荐Chrome、Edge、Safari）
- OpenRouter API密钥

### 安装步骤

1. **克隆项目**
```bash
git clone <项目地址>
cd audit-chat
```

2. **安装依赖**
```bash
npm install
```

3. **⚠️ 重要：配置API密钥**
   
   创建 `.env.local` 文件并添加您的API密钥：
   ```bash
   # 在项目根目录创建 .env.local 文件
   NEXT_PUBLIC_OPENROUTER_API_KEY=sk-or-v1-your-api-key-here
   NEXT_PUBLIC_OPENROUTER_API_BASE_URL=https://openrouter.ai/api/v1
   ```
   
   **🔒 安全注意事项：**
   - `.env.local` 文件已在 `.gitignore` 中，不会被提交到git
   - 请勿在代码中硬编码API密钥
   - 请勿将API密钥分享给他人
   - 定期更换API密钥以确保安全

4. **启动开发服务器**
```bash
npm run dev
```

5. **访问应用**
打开浏览器访问：http://localhost:3000

## 🧪 API测试

项目提供了两个测试页面：

1. **安全测试页面**：`test-api-secure.html`
   - 不包含硬编码API密钥
   - 需要手动输入API密钥进行测试
   - 适合安全环境下的测试

2. **原始测试页面**：`test-api.html`（已弃用）
   - 包含硬编码API密钥，存在安全风险
   - 仅用于快速测试（请勿在生产环境使用）

**推荐使用安全测试页面进行API功能验证。**

## 📱 使用指南

### 基本操作
1. **输入对方话语**：在文本框中输入或使用语音输入
2. **调整语气强度**：拖动滑块设置1-10的强度级别
3. **生成回复**：点击"开始沟通"按钮
4. **查看结果**：AI生成的专业回复会显示在下方

### 语音功能使用

#### 桌面端语音功能
1. **语音输入**：
   - 点击麦克风图标开始录音
   - 清晰地说出内容
   - 停顿2秒后自动添加到输入框
   - 再次点击可停止录音

2. **语音播放**：
   - 点击"播放"按钮播放输入内容
   - 点击AI回复旁的播放按钮播放回复内容

3. **语音命令**：
   - 使用语音命令面板快速操作
   - 支持"开始沟通"、"清空输入"等命令

#### 📱 移动端语音功能
1. **语音输入（移动端优化）**：
   - 点击麦克风图标开始录音
   - **连续说话**：移动端需要连续说话，不要停顿太久
   - **自动结束**：说完后会自动结束识别并添加到输入框
   - **单句模式**：每次只能识别一句话，适合移动设备
   - **环境要求**：确保在安静环境中使用，说话声音要足够大

2. **移动端权限设置**：
   - 首次使用时浏览器会请求麦克风权限，请点击"允许"
   - 如果权限被拒绝，请在浏览器设置中重新允许：
     - Chrome：设置 → 隐私设置和安全性 → 网站设置 → 麦克风
     - Safari：设置 → Safari → 网站设置 → 麦克风

3. **移动端浏览器兼容性**：
   - **推荐**：Chrome for Android、Safari for iOS
   - **支持**：Edge for Mobile、Firefox for Mobile（部分功能）
   - **注意**：请使用最新版本浏览器以获得最佳体验

4. **移动端故障排除**：
   - 如果语音识别失败，请检查：
     - 麦克风权限是否已授权
     - 网络连接是否稳定
     - 浏览器版本是否为最新
     - 是否在HTTPS环境下使用

### 🔧 语音诊断工具
访问 `/voice-test` 页面进行语音功能诊断：
- 自动检测设备类型（桌面端/移动端）
- 检查浏览器语音识别支持
- 验证麦克风权限状态
- 测试语音识别功能
- 提供针对性的解决建议

## 🔧 技术实现

### 语音识别系统
- **Web Speech API**：使用浏览器原生语音识别
- **实时转换**：边说边显示识别结果
- **智能延迟**：2秒延迟确保完整句子（桌面端）
- **移动端优化**：自动检测移动设备并应用专用配置
- **设备自适应**：
  - 桌面端：连续模式 + 中间结果显示
  - 移动端：单句模式 + 最终结果处理
- **权限管理**：移动端专用的权限获取流程
- **超时保护**：移动端10秒超时机制
- **错误处理**：完善的权限和错误处理机制

### 移动端语音优化
- **设备检测**：自动识别移动设备类型
- **配置优化**：
  - `continuous: false` - 非连续模式
  - `interimResults: false` - 关闭中间结果
  - 权限预检查和错误处理增强
- **用户体验**：
  - 移动端专用提示信息
  - 针对性的错误消息
  - 设备特定的使用指导
- **兼容性**：支持Android Chrome、iOS Safari等主流移动浏览器

### AI回复生成
- **DeepSeek V3 Base模型**：使用OpenRouter平台的免费DeepSeek模型
- **原生Fetch**：采用原生Fetch API代替OpenAI SDK，减少依赖冲突
- **流式响应**：支持实时显示生成过程
- **专业术语**：针对审计场景优化的回复模板
- **环境变量管理**：安全的API密钥存储和管理

### 性能优化
- **Server Components**：优先使用服务器组件
- **客户端缓存**：智能缓存用户输入历史
- **响应式设计**：适配各种设备屏幕
- **依赖优化**：移除重型依赖，提升加载速度

## 📋 项目结构

```
audit-chat/
├── app/                    # Next.js 14 App Router
│   ├── layout.tsx         # 根布局
│   ├── page.tsx          # 主页面
│   ├── voice-test/       # 语音测试页面
│   └── globals.css       # 全局样式
├── components/            # React组件
│   ├── ui/               # Shadcn/ui基础组件
│   ├── communication-tool.tsx  # 主要沟通工具
│   ├── input-form.tsx    # 输入表单组件
│   ├── response-list.tsx # 回复列表组件
│   └── voice-diagnostics.tsx # 语音诊断组件
├── hooks/                # 自定义Hook
│   ├── use-speech-recognition.ts # 语音识别Hook
│   ├── use-voice-commands.ts    # 语音命令Hook
│   └── use-toast.ts      # 消息提示Hook
├── lib/                  # 工具库
│   ├── api.ts           # API接口（环境变量安全版）
│   └── utils.ts         # 通用工具函数
├── .env.local           # 环境变量配置（需自行创建）
├── test-api-secure.html # 安全的API测试页面
└── types/               # TypeScript类型定义
    └── index.ts
```

## 🐛 问题排查

### API相关问题
1. **API密钥错误**
   - 检查 `.env.local` 文件是否正确配置
   - 确认API密钥格式：`sk-or-v1-...`
   - 验证API密钥是否有效且有足够配额

2. **401 认证失败**
   - API密钥可能已过期或无效
   - 检查环境变量配置是否正确
   - 确认项目重启后环境变量已加载

### 语音功能问题
1. **无法启动语音识别**
   - 检查浏览器是否支持（推荐Chrome/Edge）
   - 确认麦克风权限已授权
   - 确保使用HTTPS连接（本地开发除外）

2. **识别准确率低**
   - 确保环境安静，清晰发音
   - 检查麦克风设备是否正常
   - 尝试调整说话音量和语速

3. **AI回复失败**
   - 检查网络连接是否正常
   - 确认API服务状态
   - 查看浏览器控制台错误信息

### 📱 移动端特有问题
1. **移动端语音识别失败**
   - **最新修复（v1.6.1）**：
     - 移动端现在使用更保守的配置（关闭中间结果，只处理最终结果）
     - 增加了专门的权限预检查和延迟启动机制
     - 优化了超时处理（移动端10秒，桌面端15秒）
   - **权限问题**：
     - 确保已允许麦克风权限
     - 在浏览器设置中检查网站权限
     - 刷新页面重新请求权限
   - **浏览器兼容性**：
     - 使用Chrome for Android（推荐）或Safari for iOS
     - 更新浏览器到最新版本
     - 避免使用内置浏览器（如微信内置浏览器）

2. **移动端识别效果差**
   - **环境因素**：
     - 确保在安静环境中使用
     - 手机距离嘴部15-20cm
     - 避免在嘈杂环境中使用
   - **说话技巧**：
     - 一次说一句完整的话
     - 语速适中，发音清晰
     - 音量适中，不要太小声
     - 说完后等待2-3秒让系统处理

3. **移动端超时问题**
   - 移动端有10秒超时限制
   - 说话时间过长会自动停止
   - 建议分段输入长句子

4. **移动端网络问题**
   - 确保网络连接稳定
   - 避免在网络信号差的地方使用
   - 可以尝试切换WiFi和移动数据

5. **移动端测试步骤**：
   1. 访问 `/voice-test` 页面进行诊断
   2. 确认所有检查项都是绿色✅
   3. 点击"测试语音识别"按钮
   4. 说一句简单的话，如"你好测试"
   5. 等待识别结果显示

### 常见错误解决
- **环境变量未加载**：重启开发服务器
- **模块找不到**：运行`npm install`重新安装依赖
- **页面无法加载**：确认Node.js版本满足要求

## 🔄 更新日志

### v1.6.1 (最新) - 移动端语音识别深度优化
- 🔧 **移动端专用配置**：
  - 关闭中间结果处理，使用更稳定的最终结果模式
  - 权限预检查和延迟启动机制
  - 优化超时处理（移动端10秒，桌面端15秒）
- 🎯 **错误处理增强**：
  - 移动端专用错误信息和解决建议
  - 区分移动端和桌面端的错误处理逻辑
- 🧪 **测试优化**：
  - 移动端语音测试更加稳定
  - 详细的测试步骤和故障排除指南
- 📚 **文档更新**：移动端使用指南和测试步骤

### v1.6.0 - 移动端语音功能全面优化
- 📱 **移动端设备检测**：自动识别移动设备并启用专用优化模式
- 🎤 **移动端语音优化**：
  - 单句识别模式，适合移动设备使用习惯
  - 权限预检查和专用错误处理
  - 10秒超时保护机制
  - 移动端专用的用户提示和指导
- 🔧 **语音识别Hook重构**：
  - 支持桌面端和移动端不同配置
  - 增强的错误处理和状态管理
  - 改进的权限获取流程
- 🎨 **用户界面优化**：
  - 移动端专用提示信息
  - 设备类型显示和状态指示
  - 响应式设计改进
- 🧪 **诊断工具增强**：
  - 移动端专用的语音功能诊断
  - 详细的设备信息和浏览器兼容性检查
  - 针对性的问题解决建议
- 📚 **文档完善**：详细的移动端使用指南和故障排除

### v1.5.0 - 回复系统大幅优化
- 🎯 **智能回复生成**：全新的提示词设计，生成更自然、实用的回复
- 🎨 **差异化回复风格**：根据语气强度自动生成3种不同风格的回复（建议型、分析型、权威型等）
- 🧠 **情境智能分析**：自动识别对方回应类型（抗拒、困难、配合、解释等），提供针对性策略
- 📊 **精细语气调节**：10级语气强度，每级都有详细的行为描述和参数优化
- 🔧 **智能解析系统**：强化回复解析能力，支持多种格式，确保回复质量
- 🎛️ **动态API配置**：根据语气强度自动调整temperature等参数，获得最佳效果
- ✨ **回复质量保证**：自动去重、格式标准化、备用回复等多重保障

### v1.4.0 - 安全性大幅提升
- 🔒 **环境变量管理**：使用环境变量存储API密钥，避免硬编码
- 🔒 **安全测试页面**：创建安全的API测试页面
- 🔒 **Git安全**：确保敏感信息不会被提交到版本控制
- 🔧 **错误处理优化**：针对API密钥问题提供详细错误信息
- 🔧 **文档完善**：详细的安全配置说明
- 🆕 **DeepSeek V3 Base**：更新为最新的免费模型

### v1.3.0 - 重大修复和优化
- 🔧 **完全重构API调用系统**：使用原生Fetch API替代OpenAI SDK
- 🔧 **解决依赖冲突**：修复 `encoding` 模块缺失问题
- 🔧 **优化错误处理**：提供更详细的错误信息和解决方案
- 🔧 **移除重型依赖**：减少包体积，提升加载速度
- 🔧 **完善文件结构**：修复缺失文件，规范项目组织
- ✅ **流式响应**：保持实时显示AI生成过程
- ✅ **浏览器兼容性**：确保所有现代浏览器正常运行

### v1.2.0 - 语音功能完善
- ✅ 修复语音识别Hook系统bug
- ✅ 优化语音识别实例管理
- ✅ 完善错误处理和调试日志
- ✅ 改进语音命令响应速度
- ✅ 增强浏览器兼容性

### v1.1.0 - 语音功能增强
- ✅ 添加语音输入功能
- ✅ 实现语音播放功能  
- ✅ 集成语音命令控制
- ✅ 优化用户界面体验

### v1.0.0 - 基础版本
- ✅ AI驱动的沟通回复生成
- ✅ 语气强度调节功能
- ✅ 历史记录保存
- ✅ 响应式UI设计

## 📄 许可证

本项目采用MIT许可证 - 查看[LICENSE](LICENSE)文件了解详情

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目！

**⚠️ 安全提醒：提交代码时请确保不包含API密钥等敏感信息**

---

**专业、高效、有理有据** - 让审计沟通更加轻松！ 🚀 